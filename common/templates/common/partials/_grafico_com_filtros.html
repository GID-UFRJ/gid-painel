{# em common/partials/_grafico_com_filtros.html (VERSÃO REFORÇADA) #}

<div class="container mt-4">

    <form x-data="{}"
          x-init="$el.reset()"
          hx-get="{{ url_grafico|safe }}"
          hx-target="#{{ grafico_id }}"
          hx-trigger="change delay:300ms"
          hx-indicator="#{{ spinner_id }}"
          hx-include="closest form">

        {% block filtros %}
        {% endblock filtros %}
    </form>

    <div class="grafico position-relative">
        <div id="{{ spinner_id }}" class="htmx-indicator position-absolute ...">
            ...
        </div>

        <div id="{{ grafico_id }}">
        
        {% if grafico_html %}
            {# CAMINHO FELIZ: Se a view forneceu o HTML, renderize-o. #}
            {{ grafico_html|safe }}
        {% else %}
            {# CAMINHO DE ERRO: Se a view NÃO forneceu, mostre um erro claro. #}
            <div class="alert alert-danger border-danger p-3">
                <h5 class="fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>Erro de Implementação</h5>
                <p class="mb-1">
                    O componente de gráfico (ID: <code>{{ grafico_id }}</code>) foi renderizado sem o conteúdo inicial.
                </p>
                <hr>
                <p class="mb-0 small">
                    <strong>Ação Necessária:</strong> A view do Django que renderiza esta página <strong>deve</strong>
                    pré-renderizar o gráfico e passá-lo para o template na variável de contexto correspondente.
                    Isso é necessário para garantir a performance e evitar bugs de carregamento.
                </p>
            </div>
        {% endif %}
        </div>
    </div>
</div>