{# em common/partials/_grafico_com_filtros.html (VERSÃO REFORÇADA) #}


<div class="container mt-4">

    {# --- PASSO A: A "PONTE" DJANGO -> JAVASCRIPT --- #}
    {# Preparamos a URL base de download aqui para evitar erros de sintaxe e NoReverseMatch. #}
    {% if programa_id %}
        {% url 'common:download_csv_generic_with_id' plotter_name=plotter_name programa_id=programa_id nome_plot=nome_plot as download_base_url %}
    {% else %}
        {% url 'common:download_csv_generic' plotter_name=plotter_name nome_plot=nome_plot as download_base_url %}
    {% endif %}

    <div x-data="{ 
            downloadUrl: '#',
            updateDownloadUrl() {
                // O JavaScript agora apenas pega a URL que o Django já construiu.
                const baseUrl = '{{ download_base_url }}';
                // E anexa os parâmetros de filtro atuais do formulário.
                const params = new URLSearchParams(new FormData($refs.filtersForm)).toString();
                this.downloadUrl = `${baseUrl}?${params}`;
            }
        }"
        x-init="updateDownloadUrl()">

        <form x-ref="filtersForm"
              @change="updateDownloadUrl()"
              autocomplete="off"
              hx-get="{{ url_grafico|safe }}"
              hx-target="#{{ grafico_id }}"
              hx-trigger="change delay:300ms"
              hx-indicator="#{{ spinner_id }}"
              hx-include="this">

            {% block filtros %}
            {# Este bloco será preenchido pelo _layout_de_filtros_dinamico.html #}
            {% endblock filtros %}

        </form>

    </div>

    <div class="grafico position-relative mt-3">
        
        <div id="{{ spinner_id }}" class="htmx-indicator position-absolute top-0 start-0 w-100 h-100
                    d-flex justify-content-center align-items-center"
             style="z-index: 10; background: rgba(255,255,255,0.7); pointer-events: none;">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>

        <div id="{{ grafico_id }}">
        
        {% if grafico_html %}
            {{ grafico_html|safe }}
        {% else %}
            <div class="alert alert-danger border-danger p-3">
                <h5 class="fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>Erro de Implementação</h5>
                <p class="mb-1">
                    O componente de gráfico (ID: <code>{{ grafico_id }}</code>) foi renderizado sem o conteúdo inicial.
                </p>
                <hr>
                <p class="mb-0 small">
                    <strong>Ação Necessária:</strong> A view do Django <strong>deve</strong> pré-renderizar o gráfico e passá-lo para o template.
                </p>
            </div>
        {% endif %}
        </div>
    </div>
</div>